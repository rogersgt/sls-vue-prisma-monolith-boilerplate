AWSTemplateFormatVersion: '2010-09-09'
Description: Database migrations task

Parameters:
  RepoName:
    Type: String

  Image:
    Type: String

  Cpu:
    Type: Number

  Memory:
    Type: Number

  TaskRoleArn:
    Type: String
    Default: ''

Conditions:
  UseTaskRole: !Not [!Equals [!Ref 'TaskRoleArn', '']]

Resources:
  Task:
    Type: AWS::ECS::TaskDefinition
    Properties:
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Memory: !Ref 'Memory'
      Cpu: !Ref 'Cpu'
      ExecutionRoleArn: !GetAtt FargateTaskExecutionRole.Arn
      ContainerDefinitions:
        - Name: !Sub '${RepoName}-migrations'
          Image: !Ref 'Image'
      TaskRoleArn: !If
      - UseTaskRole
      - !Ref 'TaskRoleArn'
      - !Ref 'AWS::NoValue'

  FargateTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service:
                - 'ecs-tasks.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      Description: 'Execution role for Amazon ECS Fargate tasks'
      Policies:
        - PolicyName: 'ECSFargateTaskExecutionPolicy'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: '*'
              - Effect: 'Allow'
                Action:
                  - 'ecr:GetAuthorizationToken'
                  - 'ecr:BatchCheckLayerAvailability'
                  - 'ecr:BatchGetImage'
                  - 'ecr:GetDownloadUrlForLayer'
                Resource: '*'

  FargateServiceLinkedRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service:
                - ecs.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Description: 'Service-linked role for AWS Fargate in ECS'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy'

  ECSCluster:
    Type: 'AWS::ECS::Cluster'
    DependsOn:
      - FargateServiceLinkedRole
    Properties:
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1
        - CapacityProvider: FARGATE_SPOT
          Weight: 1

Outputs:
  TaskArn:
    Value: !GetAtt Task.TaskDefinitionArn

  ClusterName:
    Value: !Ref ECSCluster
